"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const typescript_1 = require("../utils/typescript");
const file_utils_1 = require("./file-utils");
const project_graph_models_1 = require("./project-graph/project-graph-models");
class TargetProjectLocator {
    constructor(nodes) {
        this.nodes = nodes;
        this._sortedNodeNames = [];
        this._sortedNodeNames = Object.keys(nodes).sort((a, b) => {
            // If a or b is not a nx project, leave them in the same spot
            if (!this._isNxProject(nodes[a].type) &&
                !this._isNxProject(nodes[b].type)) {
                return 0;
            }
            // sort all non-projects lower
            if (!this._isNxProject(nodes[a].type) &&
                this._isNxProject(nodes[b].type)) {
                return 1;
            }
            if (this._isNxProject(nodes[a].type) &&
                !this._isNxProject(nodes[b].type)) {
                return -1;
            }
            return nodes[a].data.root.length > nodes[b].data.root.length ? -1 : 1;
        });
    }
    findProjectWithImport(importExpr, filePath, npmScope) {
        const normalizedImportExpr = importExpr.split('#')[0];
        const resolvedModule = typescript_1.resolveModuleByImport(normalizedImportExpr, filePath);
        return this._sortedNodeNames.find(projectName => {
            const p = this.nodes[projectName];
            if (!this._isNxProject(p.type)) {
                return false;
            }
            if (resolvedModule && resolvedModule.startsWith(p.data.root)) {
                return true;
            }
            else {
                const normalizedRoot = file_utils_1.normalizedProjectRoot(p);
                const projectImport = `@${npmScope}/${normalizedRoot}`;
                return normalizedImportExpr.startsWith(projectImport);
            }
        });
    }
    _isNxProject(type) {
        return (type === project_graph_models_1.ProjectType.app ||
            type === project_graph_models_1.ProjectType.lib ||
            type === project_graph_models_1.ProjectType.e2e);
    }
}
exports.TargetProjectLocator = TargetProjectLocator;
