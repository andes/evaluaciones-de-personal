import { __decorate } from "tslib";
import { ChangeDetectorRef, Directive, EmbeddedViewRef, Input, OnDestroy, OnInit, TemplateRef, ViewContainerRef, Éµstringify as stringify } from '@angular/core';
import { AsyncSubject, Subject } from 'rxjs';
import { concatMap, takeUntil } from 'rxjs/operators';
function assertTemplate(property, templateRef) {
    var isTemplateRefOrNull = !!(!templateRef || templateRef.createEmbeddedView);
    if (!isTemplateRefOrNull) {
        throw new Error(property + " must be a TemplateRef, but received '" + stringify(templateRef) + "'.");
    }
}
var ObserveContext = /** @class */ (function () {
    function ObserveContext(value) {
        this.$implicit = value;
        this.ngxObserve = value;
    }
    return ObserveContext;
}());
export { ObserveContext };
var ErrorContext = /** @class */ (function () {
    function ErrorContext(error) {
        this.$implicit = error;
    }
    return ErrorContext;
}());
export { ErrorContext };
var NgxObserve = /** @class */ (function () {
    function NgxObserve(view, changes, nextTemplateRef) {
        this.view = view;
        this.changes = changes;
        this.unsubscribe = new Subject();
        this.init = new AsyncSubject();
        this.nextTemplateRef = nextTemplateRef;
    }
    Object.defineProperty(NgxObserve.prototype, "ngxObserve", {
        set: function (source) {
            var _this = this;
            if (this.source && source !== this.source) {
                this.unsubscribe.next(undefined);
            }
            if (source && source !== this.source) {
                if (this.beforeTemplateRef) {
                    this.view.clear();
                    this.nextViewRef = undefined;
                    this.errorViewRef = undefined;
                    this.beforeViewRef = this.view.createEmbeddedView(this.beforeTemplateRef);
                }
                this.init.pipe(concatMap(function () {
                    if (_this.beforeTemplateRef) {
                        _this.view.clear();
                        _this.nextViewRef = undefined;
                        _this.errorViewRef = undefined;
                        _this.beforeViewRef = _this.view.createEmbeddedView(_this.beforeTemplateRef);
                    }
                    return source;
                }), takeUntil(this.unsubscribe)).subscribe(function (value) {
                    _this.view.clear();
                    _this.errorViewRef = undefined;
                    _this.beforeViewRef = undefined;
                    _this.nextViewRef = _this.view.createEmbeddedView(_this.nextTemplateRef, new ObserveContext(value));
                    _this.changes.markForCheck();
                }, function (error) {
                    if (_this.errorTemplateRef) {
                        _this.view.clear();
                        _this.beforeViewRef = undefined;
                        _this.nextViewRef = undefined;
                        _this.errorViewRef = _this.view.createEmbeddedView(_this.errorTemplateRef, new ErrorContext(error));
                        _this.changes.markForCheck();
                    }
                });
            }
            this.source = source;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgxObserve.prototype, "ngxObserveError", {
        set: function (ref) {
            assertTemplate('ngxObserveError', ref);
            this.errorTemplateRef = ref;
            if (this.errorViewRef) {
                this.view.clear();
                this.errorViewRef = this.view.createEmbeddedView(this.errorTemplateRef, this.errorViewRef.context);
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgxObserve.prototype, "ngxObserveBefore", {
        set: function (ref) {
            assertTemplate('ngxObserveBefore', ref);
            this.beforeTemplateRef = ref;
            if (this.beforeViewRef) {
                this.view.clear();
                this.beforeViewRef = this.view.createEmbeddedView(this.beforeTemplateRef);
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgxObserve.prototype, "ngxObserveNext", {
        set: function (ref) {
            assertTemplate('ngxObserveNext', ref);
            this.nextTemplateRef = ref;
            if (this.nextViewRef) {
                this.view.clear();
                this.nextViewRef = this.view.createEmbeddedView(this.nextTemplateRef, this.nextViewRef.context);
                this.changes.markForCheck();
            }
        },
        enumerable: true,
        configurable: true
    });
    NgxObserve.ngTemplateContextGuard = function (dir, ctx) {
        return true;
    };
    NgxObserve.prototype.ngOnDestroy = function () {
        this.unsubscribe.next(undefined);
    };
    NgxObserve.prototype.ngOnInit = function () {
        this.init.next(undefined);
        this.init.complete();
    };
    NgxObserve.ctorParameters = function () { return [
        { type: ViewContainerRef },
        { type: ChangeDetectorRef },
        { type: TemplateRef }
    ]; };
    __decorate([
        Input()
    ], NgxObserve.prototype, "ngxObserve", null);
    __decorate([
        Input()
    ], NgxObserve.prototype, "ngxObserveError", null);
    __decorate([
        Input()
    ], NgxObserve.prototype, "ngxObserveBefore", null);
    __decorate([
        Input()
    ], NgxObserve.prototype, "ngxObserveNext", null);
    NgxObserve = __decorate([
        Directive({
            selector: '[ngxObserve]'
        })
    ], NgxObserve);
    return NgxObserve;
}());
export { NgxObserve };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LW9ic2VydmUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LW9ic2VydmUvIiwic291cmNlcyI6WyJsaWIvbmd4LW9ic2VydmUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVCxlQUFlLEVBQ2YsS0FBSyxFQUNMLFNBQVMsRUFDVCxNQUFNLEVBQ04sV0FBVyxFQUNYLGdCQUFnQixFQUNoQixVQUFVLElBQUksU0FBUyxFQUN4QixNQUFNLGVBQWUsQ0FBQTtBQUN0QixPQUFPLEVBQUMsWUFBWSxFQUFjLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQTtBQUN0RCxPQUFPLEVBQUMsU0FBUyxFQUFFLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFBO0FBRW5ELFNBQVMsY0FBYyxDQUFDLFFBQWdCLEVBQUUsV0FBb0M7SUFDNUUsSUFBTSxtQkFBbUIsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsSUFBSSxXQUFXLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtJQUM5RSxJQUFJLENBQUMsbUJBQW1CLEVBQUU7UUFDeEIsTUFBTSxJQUFJLEtBQUssQ0FBSSxRQUFRLDhDQUF5QyxTQUFTLENBQUMsV0FBVyxDQUFDLE9BQUksQ0FBQyxDQUFBO0tBQ2hHO0FBQ0gsQ0FBQztBQUVEO0lBSUUsd0JBQVksS0FBUTtRQUNsQixJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQTtRQUN0QixJQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQTtJQUN6QixDQUFDO0lBQ0gscUJBQUM7QUFBRCxDQUFDLEFBUkQsSUFRQzs7QUFFRDtJQUdFLHNCQUFZLEtBQVk7UUFDdEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUE7SUFDeEIsQ0FBQztJQUNILG1CQUFDO0FBQUQsQ0FBQyxBQU5ELElBTUM7O0FBS0Q7SUFlRSxvQkFDVSxJQUFzQixFQUN0QixPQUEwQixFQUNsQyxl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Q0FBQzs7O09BQUE7SUFFTSxpQ0FBc0IsR0FBN0IsVUFBaUMsR0FBa0IsRUFBRSxHQUFRO1FBQzNELE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUVELGdDQUFXLEdBQVg7UUFDRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQTtJQUNsQyxDQUFDO0lBRUQsNkJBQVEsR0FBUjtRQUNFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQ3pCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUE7SUFDdEIsQ0FBQzs7Z0JBM0ZlLGdCQUFnQjtnQkFDYixpQkFBaUI7Z0JBQ2pCLFdBQVc7O0lBTTlCO1FBREMsS0FBSyxFQUFFO2dEQXdDUDtJQUdEO1FBREMsS0FBSyxFQUFFO3FEQVFQO0lBR0Q7UUFEQyxLQUFLLEVBQUU7c0RBUVA7SUFHRDtRQURDLEtBQUssRUFBRTtvREFTUDtJQTlGVSxVQUFVO1FBSHRCLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxjQUFjO1NBQ3pCLENBQUM7T0FDVyxVQUFVLENBNkd0QjtJQUFELGlCQUFDO0NBQUEsQUE3R0QsSUE2R0M7U0E3R1ksVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENoYW5nZURldGVjdG9yUmVmLFxuICBEaXJlY3RpdmUsXG4gIEVtYmVkZGVkVmlld1JlZixcbiAgSW5wdXQsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBUZW1wbGF0ZVJlZixcbiAgVmlld0NvbnRhaW5lclJlZixcbiAgybVzdHJpbmdpZnkgYXMgc3RyaW5naWZ5XG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnXG5pbXBvcnQge0FzeW5jU3ViamVjdCwgT2JzZXJ2YWJsZSwgU3ViamVjdH0gZnJvbSAncnhqcydcbmltcG9ydCB7Y29uY2F0TWFwLCB0YWtlVW50aWx9IGZyb20gJ3J4anMvb3BlcmF0b3JzJ1xuXG5mdW5jdGlvbiBhc3NlcnRUZW1wbGF0ZShwcm9wZXJ0eTogc3RyaW5nLCB0ZW1wbGF0ZVJlZjogVGVtcGxhdGVSZWY8YW55PiB8IG51bGwpOiB2b2lkIHtcbiAgY29uc3QgaXNUZW1wbGF0ZVJlZk9yTnVsbCA9ICEhKCF0ZW1wbGF0ZVJlZiB8fCB0ZW1wbGF0ZVJlZi5jcmVhdGVFbWJlZGRlZFZpZXcpXG4gIGlmICghaXNUZW1wbGF0ZVJlZk9yTnVsbCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgJHtwcm9wZXJ0eX0gbXVzdCBiZSBhIFRlbXBsYXRlUmVmLCBidXQgcmVjZWl2ZWQgJyR7c3RyaW5naWZ5KHRlbXBsYXRlUmVmKX0nLmApXG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIE9ic2VydmVDb250ZXh0PFQgPSB1bmtub3duPiB7XG4gICRpbXBsaWNpdDogVFxuICBuZ3hPYnNlcnZlOiBUXG5cbiAgY29uc3RydWN0b3IodmFsdWU6IFQpIHtcbiAgICB0aGlzLiRpbXBsaWNpdCA9IHZhbHVlXG4gICAgdGhpcy5uZ3hPYnNlcnZlID0gdmFsdWVcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgRXJyb3JDb250ZXh0IHtcbiAgJGltcGxpY2l0OiBFcnJvclxuXG4gIGNvbnN0cnVjdG9yKGVycm9yOiBFcnJvcikge1xuICAgIHRoaXMuJGltcGxpY2l0ID0gZXJyb3JcbiAgfVxufVxuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbbmd4T2JzZXJ2ZV0nXG59KVxuZXhwb3J0IGNsYXNzIE5neE9ic2VydmU8VCA9IHVua25vd24+IGltcGxlbWVudHMgT25EZXN0cm95LCBPbkluaXQge1xuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp2YXJpYWJsZS1uYW1lXG4gIHN0YXRpYyBuZ1RlbXBsYXRlR3VhcmRfbmd4T2JzZXJ2ZTogJ2JpbmRpbmcnXG5cbiAgcHJpdmF0ZSBuZXh0VGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPE9ic2VydmVDb250ZXh0PFQ+PlxuICBwcml2YXRlIGVycm9yVGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPEVycm9yQ29udGV4dD5cbiAgcHJpdmF0ZSBiZWZvcmVUZW1wbGF0ZVJlZjogVGVtcGxhdGVSZWY8dW5kZWZpbmVkPlxuICBwcml2YXRlIG5leHRWaWV3UmVmOiBFbWJlZGRlZFZpZXdSZWY8T2JzZXJ2ZUNvbnRleHQ8VD4+IHwgdW5kZWZpbmVkXG4gIHByaXZhdGUgZXJyb3JWaWV3UmVmOiBFbWJlZGRlZFZpZXdSZWY8RXJyb3JDb250ZXh0PiB8IHVuZGVmaW5lZFxuICBwcml2YXRlIGJlZm9yZVZpZXdSZWY6IEVtYmVkZGVkVmlld1JlZjx1bmRlZmluZWQ+IHwgdW5kZWZpbmVkXG4gIHByaXZhdGUgdW5zdWJzY3JpYmUgPSBuZXcgU3ViamVjdDx2b2lkPigpXG4gIHByaXZhdGUgaW5pdCA9IG5ldyBBc3luY1N1YmplY3Q8dm9pZD4oKVxuICBwcml2YXRlIHNvdXJjZTogT2JzZXJ2YWJsZTxUPlxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdmlldzogVmlld0NvbnRhaW5lclJlZixcbiAgICBwcml2YXRlIGNoYW5nZXM6IENoYW5nZURldGVjdG9yUmVmLFxuICAgIG5leHRUZW1wbGF0ZVJlZjogVGVtcGxhdGVSZWY8T2JzZXJ2ZUNvbnRleHQ8VD4+XG4gICkge1xuICAgIHRoaXMubmV4dFRlbXBsYXRlUmVmID0gbmV4dFRlbXBsYXRlUmVmXG4gIH1cblxuICBASW5wdXQoKVxuICBzZXQgbmd4T2JzZXJ2ZShzb3VyY2U6IE9ic2VydmFibGU8VD4pIHtcbiAgICBpZiAodGhpcy5zb3VyY2UgJiYgc291cmNlICE9PSB0aGlzLnNvdXJjZSkge1xuICAgICAgdGhpcy51bnN1YnNjcmliZS5uZXh0KHVuZGVmaW5lZClcbiAgICB9XG4gICAgaWYgKHNvdXJjZSAmJiBzb3VyY2UgIT09IHRoaXMuc291cmNlKSB7XG4gICAgICBpZiAodGhpcy5iZWZvcmVUZW1wbGF0ZVJlZikge1xuICAgICAgICB0aGlzLnZpZXcuY2xlYXIoKVxuICAgICAgICB0aGlzLm5leHRWaWV3UmVmID0gdW5kZWZpbmVkXG4gICAgICAgIHRoaXMuZXJyb3JWaWV3UmVmID0gdW5kZWZpbmVkXG4gICAgICAgIHRoaXMuYmVmb3JlVmlld1JlZiA9IHRoaXMudmlldy5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy5iZWZvcmVUZW1wbGF0ZVJlZilcbiAgICAgIH1cbiAgICAgIHRoaXMuaW5pdC5waXBlKFxuICAgICAgICBjb25jYXRNYXAoKCkgPT4ge1xuICAgICAgICAgIGlmICh0aGlzLmJlZm9yZVRlbXBsYXRlUmVmKSB7XG4gICAgICAgICAgICB0aGlzLnZpZXcuY2xlYXIoKVxuICAgICAgICAgICAgdGhpcy5uZXh0Vmlld1JlZiA9IHVuZGVmaW5lZFxuICAgICAgICAgICAgdGhpcy5lcnJvclZpZXdSZWYgPSB1bmRlZmluZWRcbiAgICAgICAgICAgIHRoaXMuYmVmb3JlVmlld1JlZiA9IHRoaXMudmlldy5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy5iZWZvcmVUZW1wbGF0ZVJlZilcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHNvdXJjZVxuICAgICAgICB9KSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMudW5zdWJzY3JpYmUpXG4gICAgICApLnN1YnNjcmliZSh2YWx1ZSA9PiB7XG4gICAgICAgIHRoaXMudmlldy5jbGVhcigpXG4gICAgICAgIHRoaXMuZXJyb3JWaWV3UmVmID0gdW5kZWZpbmVkXG4gICAgICAgIHRoaXMuYmVmb3JlVmlld1JlZiA9IHVuZGVmaW5lZFxuICAgICAgICB0aGlzLm5leHRWaWV3UmVmID0gdGhpcy52aWV3LmNyZWF0ZUVtYmVkZGVkVmlldyh0aGlzLm5leHRUZW1wbGF0ZVJlZiwgbmV3IE9ic2VydmVDb250ZXh0PFQ+KHZhbHVlKSlcbiAgICAgICAgdGhpcy5jaGFuZ2VzLm1hcmtGb3JDaGVjaygpXG4gICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgIGlmICh0aGlzLmVycm9yVGVtcGxhdGVSZWYpIHtcbiAgICAgICAgICB0aGlzLnZpZXcuY2xlYXIoKVxuICAgICAgICAgIHRoaXMuYmVmb3JlVmlld1JlZiA9IHVuZGVmaW5lZFxuICAgICAgICAgIHRoaXMubmV4dFZpZXdSZWYgPSB1bmRlZmluZWRcbiAgICAgICAgICB0aGlzLmVycm9yVmlld1JlZiA9IHRoaXMudmlldy5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy5lcnJvclRlbXBsYXRlUmVmLCBuZXcgRXJyb3JDb250ZXh0KGVycm9yKSlcbiAgICAgICAgICB0aGlzLmNoYW5nZXMubWFya0ZvckNoZWNrKClcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9XG4gICAgdGhpcy5zb3VyY2UgPSBzb3VyY2VcbiAgfVxuXG4gIEBJbnB1dCgpXG4gIHNldCBuZ3hPYnNlcnZlRXJyb3IocmVmOiBUZW1wbGF0ZVJlZjxFcnJvckNvbnRleHQ+KSB7XG4gICAgYXNzZXJ0VGVtcGxhdGUoJ25neE9ic2VydmVFcnJvcicsIHJlZilcbiAgICB0aGlzLmVycm9yVGVtcGxhdGVSZWYgPSByZWZcbiAgICBpZiAodGhpcy5lcnJvclZpZXdSZWYpIHtcbiAgICAgIHRoaXMudmlldy5jbGVhcigpXG4gICAgICB0aGlzLmVycm9yVmlld1JlZiA9IHRoaXMudmlldy5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy5lcnJvclRlbXBsYXRlUmVmLCB0aGlzLmVycm9yVmlld1JlZi5jb250ZXh0KVxuICAgIH1cbiAgfVxuXG4gIEBJbnB1dCgpXG4gIHNldCBuZ3hPYnNlcnZlQmVmb3JlKHJlZjogVGVtcGxhdGVSZWY8dW5kZWZpbmVkPikge1xuICAgIGFzc2VydFRlbXBsYXRlKCduZ3hPYnNlcnZlQmVmb3JlJywgcmVmKVxuICAgIHRoaXMuYmVmb3JlVGVtcGxhdGVSZWYgPSByZWZcbiAgICBpZiAodGhpcy5iZWZvcmVWaWV3UmVmKSB7XG4gICAgICB0aGlzLnZpZXcuY2xlYXIoKVxuICAgICAgdGhpcy5iZWZvcmVWaWV3UmVmID0gdGhpcy52aWV3LmNyZWF0ZUVtYmVkZGVkVmlldyh0aGlzLmJlZm9yZVRlbXBsYXRlUmVmKVxuICAgIH1cbiAgfVxuXG4gIEBJbnB1dCgpXG4gIHNldCBuZ3hPYnNlcnZlTmV4dChyZWY6IFRlbXBsYXRlUmVmPE9ic2VydmVDb250ZXh0PFQ+Pikge1xuICAgIGFzc2VydFRlbXBsYXRlKCduZ3hPYnNlcnZlTmV4dCcsIHJlZilcbiAgICB0aGlzLm5leHRUZW1wbGF0ZVJlZiA9IHJlZlxuICAgIGlmICh0aGlzLm5leHRWaWV3UmVmKSB7XG4gICAgICB0aGlzLnZpZXcuY2xlYXIoKVxuICAgICAgdGhpcy5uZXh0Vmlld1JlZiA9IHRoaXMudmlldy5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy5uZXh0VGVtcGxhdGVSZWYsIHRoaXMubmV4dFZpZXdSZWYuY29udGV4dClcbiAgICAgIHRoaXMuY2hhbmdlcy5tYXJrRm9yQ2hlY2soKVxuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBuZ1RlbXBsYXRlQ29udGV4dEd1YXJkPFQ+KGRpcjogTmd4T2JzZXJ2ZTxUPiwgY3R4OiBhbnkpOiBjdHggaXMgT2JzZXJ2ZUNvbnRleHQ8Tm9uTnVsbGFibGU8VD4+IHtcbiAgICByZXR1cm4gdHJ1ZVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy51bnN1YnNjcmliZS5uZXh0KHVuZGVmaW5lZClcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuaW5pdC5uZXh0KHVuZGVmaW5lZClcbiAgICB0aGlzLmluaXQuY29tcGxldGUoKVxuICB9XG5cbn1cbiJdfQ==