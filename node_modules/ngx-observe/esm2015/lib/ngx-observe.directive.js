import { __decorate } from "tslib";
import { ChangeDetectorRef, Directive, EmbeddedViewRef, Input, OnDestroy, OnInit, TemplateRef, ViewContainerRef, Éµstringify as stringify } from '@angular/core';
import { AsyncSubject, Subject } from 'rxjs';
import { concatMap, takeUntil } from 'rxjs/operators';
function assertTemplate(property, templateRef) {
    const isTemplateRefOrNull = !!(!templateRef || templateRef.createEmbeddedView);
    if (!isTemplateRefOrNull) {
        throw new Error(`${property} must be a TemplateRef, but received '${stringify(templateRef)}'.`);
    }
}
export class ObserveContext {
    constructor(value) {
        this.$implicit = value;
        this.ngxObserve = value;
    }
}
export class ErrorContext {
    constructor(error) {
        this.$implicit = error;
    }
}
let NgxObserve = class NgxObserve {
    constructor(view, changes, nextTemplateRef) {
        this.view = view;
        this.changes = changes;
        this.unsubscribe = new Subject();
        this.init = new AsyncSubject();
        this.nextTemplateRef = nextTemplateRef;
    }
    set ngxObserve(source) {
        if (this.source && source !== this.source) {
            this.unsubscribe.next(undefined);
        }
        if (source && source !== this.source) {
            if (this.beforeTemplateRef) {
                this.view.clear();
                this.nextViewRef = undefined;
                this.errorViewRef = undefined;
                this.beforeViewRef = this.view.createEmbeddedView(this.beforeTemplateRef);
            }
            this.init.pipe(concatMap(() => {
                if (this.beforeTemplateRef) {
                    this.view.clear();
                    this.nextViewRef = undefined;
                    this.errorViewRef = undefined;
                    this.beforeViewRef = this.view.createEmbeddedView(this.beforeTemplateRef);
                }
                return source;
            }), takeUntil(this.unsubscribe)).subscribe(value => {
                this.view.clear();
                this.errorViewRef = undefined;
                this.beforeViewRef = undefined;
                this.nextViewRef = this.view.createEmbeddedView(this.nextTemplateRef, new ObserveContext(value));
                this.changes.markForCheck();
            }, error => {
                if (this.errorTemplateRef) {
                    this.view.clear();
                    this.beforeViewRef = undefined;
                    this.nextViewRef = undefined;
                    this.errorViewRef = this.view.createEmbeddedView(this.errorTemplateRef, new ErrorContext(error));
                    this.changes.markForCheck();
                }
            });
        }
        this.source = source;
    }
    set ngxObserveError(ref) {
        assertTemplate('ngxObserveError', ref);
        this.errorTemplateRef = ref;
        if (this.errorViewRef) {
            this.view.clear();
            this.errorViewRef = this.view.createEmbeddedView(this.errorTemplateRef, this.errorViewRef.context);
        }
    }
    set ngxObserveBefore(ref) {
        assertTemplate('ngxObserveBefore', ref);
        this.beforeTemplateRef = ref;
        if (this.beforeViewRef) {
            this.view.clear();
            this.beforeViewRef = this.view.createEmbeddedView(this.beforeTemplateRef);
        }
    }
    set ngxObserveNext(ref) {
        assertTemplate('ngxObserveNext', ref);
        this.nextTemplateRef = ref;
        if (this.nextViewRef) {
            this.view.clear();
            this.nextViewRef = this.view.createEmbeddedView(this.nextTemplateRef, this.nextViewRef.context);
            this.changes.markForCheck();
        }
    }
    static ngTemplateContextGuard(dir, ctx) {
        return true;
    }
    ngOnDestroy() {
        this.unsubscribe.next(undefined);
    }
    ngOnInit() {
        this.init.next(undefined);
        this.init.complete();
    }
};
NgxObserve.ctorParameters = () => [
    { type: ViewContainerRef },
    { type: ChangeDetectorRef },
    { type: TemplateRef }
];
__decorate([
    Input()
], NgxObserve.prototype, "ngxObserve", null);
__decorate([
    Input()
], NgxObserve.prototype, "ngxObserveError", null);
__decorate([
    Input()
], NgxObserve.prototype, "ngxObserveBefore", null);
__decorate([
    Input()
], NgxObserve.prototype, "ngxObserveNext", null);
NgxObserve = __decorate([
    Directive({
        selector: '[ngxObserve]'
    })
], NgxObserve);
export { NgxObserve };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LW9ic2VydmUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LW9ic2VydmUvIiwic291cmNlcyI6WyJsaWIvbmd4LW9ic2VydmUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVCxlQUFlLEVBQ2YsS0FBSyxFQUNMLFNBQVMsRUFDVCxNQUFNLEVBQ04sV0FBVyxFQUNYLGdCQUFnQixFQUNoQixVQUFVLElBQUksU0FBUyxFQUN4QixNQUFNLGVBQWUsQ0FBQTtBQUN0QixPQUFPLEVBQUMsWUFBWSxFQUFjLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQTtBQUN0RCxPQUFPLEVBQUMsU0FBUyxFQUFFLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFBO0FBRW5ELFNBQVMsY0FBYyxDQUFDLFFBQWdCLEVBQUUsV0FBb0M7SUFDNUUsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsSUFBSSxXQUFXLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtJQUM5RSxJQUFJLENBQUMsbUJBQW1CLEVBQUU7UUFDeEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxHQUFHLFFBQVEseUNBQXlDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUE7S0FDaEc7QUFDSCxDQUFDO0FBRUQsTUFBTSxPQUFPLGNBQWM7SUFJekIsWUFBWSxLQUFRO1FBQ2xCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFBO1FBQ3RCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFBO0lBQ3pCLENBQUM7Q0FDRjtBQUVELE1BQU0sT0FBTyxZQUFZO0lBR3ZCLFlBQVksS0FBWTtRQUN0QixJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQTtJQUN4QixDQUFDO0NBQ0Y7QUFLRCxJQUFhLFVBQVUsR0FBdkIsTUFBYSxVQUFVO0lBZXJCLFlBQ1UsSUFBc0IsRUFDdEIsT0FBMEIsRUFDbEMsZUFBK0M7UUFGdkMsU0FBSSxHQUFKLElBQUksQ0FBa0I7UUFDdEIsWUFBTyxHQUFQLE9BQU8sQ0FBbUI7UUFONUIsZ0JBQVcsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFBO1FBQ2pDLFNBQUksR0FBRyxJQUFJLFlBQVksRUFBUSxDQUFBO1FBUXJDLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFBO0lBQ3hDLENBQUM7SUFHRCxJQUFJLFVBQVUsQ0FBQyxNQUFxQjtRQUNsQyxJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksTUFBTSxLQUFLLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDekMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUE7U0FDakM7UUFDRCxJQUFJLE1BQU0sSUFBSSxNQUFNLEtBQUssSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNwQyxJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtnQkFDMUIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQTtnQkFDakIsSUFBSSxDQUFDLFdBQVcsR0FBRyxTQUFTLENBQUE7Z0JBQzVCLElBQUksQ0FBQyxZQUFZLEdBQUcsU0FBUyxDQUFBO2dCQUM3QixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUE7YUFDMUU7WUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FDWixTQUFTLENBQUMsR0FBRyxFQUFFO2dCQUNiLElBQUksSUFBSSxDQUFDLGlCQUFpQixFQUFFO29CQUMxQixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFBO29CQUNqQixJQUFJLENBQUMsV0FBVyxHQUFHLFNBQVMsQ0FBQTtvQkFDNUIsSUFBSSxDQUFDLFlBQVksR0FBRyxTQUFTLENBQUE7b0JBQzdCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtpQkFDMUU7Z0JBQ0QsT0FBTyxNQUFNLENBQUE7WUFDZixDQUFDLENBQUMsRUFDRixTQUFTLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUM1QixDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDbEIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQTtnQkFDakIsSUFBSSxDQUFDLFlBQVksR0FBRyxTQUFTLENBQUE7Z0JBQzdCLElBQUksQ0FBQyxhQUFhLEdBQUcsU0FBUyxDQUFBO2dCQUM5QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxJQUFJLGNBQWMsQ0FBSSxLQUFLLENBQUMsQ0FBQyxDQUFBO2dCQUNuRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFBO1lBQzdCLENBQUMsRUFBRSxLQUFLLENBQUMsRUFBRTtnQkFDVCxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtvQkFDekIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQTtvQkFDakIsSUFBSSxDQUFDLGFBQWEsR0FBRyxTQUFTLENBQUE7b0JBQzlCLElBQUksQ0FBQyxXQUFXLEdBQUcsU0FBUyxDQUFBO29CQUM1QixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLElBQUksWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7b0JBQ2hHLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUE7aUJBQzVCO1lBQ0gsQ0FBQyxDQUFDLENBQUE7U0FDSDtRQUNELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFBO0lBQ3RCLENBQUM7SUFHRCxJQUFJLGVBQWUsQ0FBQyxHQUE4QjtRQUNoRCxjQUFjLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxDQUFDLENBQUE7UUFDdEMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEdBQUcsQ0FBQTtRQUMzQixJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDckIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQTtZQUNqQixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUE7U0FDbkc7SUFDSCxDQUFDO0lBR0QsSUFBSSxnQkFBZ0IsQ0FBQyxHQUEyQjtRQUM5QyxjQUFjLENBQUMsa0JBQWtCLEVBQUUsR0FBRyxDQUFDLENBQUE7UUFDdkMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEdBQUcsQ0FBQTtRQUM1QixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdEIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQTtZQUNqQixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUE7U0FDMUU7SUFDSCxDQUFDO0lBR0QsSUFBSSxjQUFjLENBQUMsR0FBbUM7UUFDcEQsY0FBYyxDQUFDLGdCQUFnQixFQUFFLEdBQUcsQ0FBQyxDQUFBO1FBQ3JDLElBQUksQ0FBQyxlQUFlLEdBQUcsR0FBRyxDQUFBO1FBQzFCLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNwQixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFBO1lBQ2pCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUE7WUFDL0YsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQTtTQUM1QjtJQUNILENBQUM7SUFFRCxNQUFNLENBQUMsc0JBQXNCLENBQUksR0FBa0IsRUFBRSxHQUFRO1FBQzNELE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQTtJQUNsQyxDQUFDO0lBRUQsUUFBUTtRQUNOLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQ3pCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUE7SUFDdEIsQ0FBQztDQUVGLENBQUE7O1lBN0ZpQixnQkFBZ0I7WUFDYixpQkFBaUI7WUFDakIsV0FBVzs7QUFNOUI7SUFEQyxLQUFLLEVBQUU7NENBd0NQO0FBR0Q7SUFEQyxLQUFLLEVBQUU7aURBUVA7QUFHRDtJQURDLEtBQUssRUFBRTtrREFRUDtBQUdEO0lBREMsS0FBSyxFQUFFO2dEQVNQO0FBOUZVLFVBQVU7SUFIdEIsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLGNBQWM7S0FDekIsQ0FBQztHQUNXLFVBQVUsQ0E2R3RCO1NBN0dZLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgRGlyZWN0aXZlLFxuICBFbWJlZGRlZFZpZXdSZWYsXG4gIElucHV0LFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgVGVtcGxhdGVSZWYsXG4gIFZpZXdDb250YWluZXJSZWYsXG4gIMm1c3RyaW5naWZ5IGFzIHN0cmluZ2lmeVxufSBmcm9tICdAYW5ndWxhci9jb3JlJ1xuaW1wb3J0IHtBc3luY1N1YmplY3QsIE9ic2VydmFibGUsIFN1YmplY3R9IGZyb20gJ3J4anMnXG5pbXBvcnQge2NvbmNhdE1hcCwgdGFrZVVudGlsfSBmcm9tICdyeGpzL29wZXJhdG9ycydcblxuZnVuY3Rpb24gYXNzZXJ0VGVtcGxhdGUocHJvcGVydHk6IHN0cmluZywgdGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPGFueT4gfCBudWxsKTogdm9pZCB7XG4gIGNvbnN0IGlzVGVtcGxhdGVSZWZPck51bGwgPSAhISghdGVtcGxhdGVSZWYgfHwgdGVtcGxhdGVSZWYuY3JlYXRlRW1iZWRkZWRWaWV3KVxuICBpZiAoIWlzVGVtcGxhdGVSZWZPck51bGwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCR7cHJvcGVydHl9IG11c3QgYmUgYSBUZW1wbGF0ZVJlZiwgYnV0IHJlY2VpdmVkICcke3N0cmluZ2lmeSh0ZW1wbGF0ZVJlZil9Jy5gKVxuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBPYnNlcnZlQ29udGV4dDxUID0gdW5rbm93bj4ge1xuICAkaW1wbGljaXQ6IFRcbiAgbmd4T2JzZXJ2ZTogVFxuXG4gIGNvbnN0cnVjdG9yKHZhbHVlOiBUKSB7XG4gICAgdGhpcy4kaW1wbGljaXQgPSB2YWx1ZVxuICAgIHRoaXMubmd4T2JzZXJ2ZSA9IHZhbHVlXG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEVycm9yQ29udGV4dCB7XG4gICRpbXBsaWNpdDogRXJyb3JcblxuICBjb25zdHJ1Y3RvcihlcnJvcjogRXJyb3IpIHtcbiAgICB0aGlzLiRpbXBsaWNpdCA9IGVycm9yXG4gIH1cbn1cblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnW25neE9ic2VydmVdJ1xufSlcbmV4cG9ydCBjbGFzcyBOZ3hPYnNlcnZlPFQgPSB1bmtub3duPiBpbXBsZW1lbnRzIE9uRGVzdHJveSwgT25Jbml0IHtcblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dmFyaWFibGUtbmFtZVxuICBzdGF0aWMgbmdUZW1wbGF0ZUd1YXJkX25neE9ic2VydmU6ICdiaW5kaW5nJ1xuXG4gIHByaXZhdGUgbmV4dFRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxPYnNlcnZlQ29udGV4dDxUPj5cbiAgcHJpdmF0ZSBlcnJvclRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxFcnJvckNvbnRleHQ+XG4gIHByaXZhdGUgYmVmb3JlVGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPHVuZGVmaW5lZD5cbiAgcHJpdmF0ZSBuZXh0Vmlld1JlZjogRW1iZWRkZWRWaWV3UmVmPE9ic2VydmVDb250ZXh0PFQ+PiB8IHVuZGVmaW5lZFxuICBwcml2YXRlIGVycm9yVmlld1JlZjogRW1iZWRkZWRWaWV3UmVmPEVycm9yQ29udGV4dD4gfCB1bmRlZmluZWRcbiAgcHJpdmF0ZSBiZWZvcmVWaWV3UmVmOiBFbWJlZGRlZFZpZXdSZWY8dW5kZWZpbmVkPiB8IHVuZGVmaW5lZFxuICBwcml2YXRlIHVuc3Vic2NyaWJlID0gbmV3IFN1YmplY3Q8dm9pZD4oKVxuICBwcml2YXRlIGluaXQgPSBuZXcgQXN5bmNTdWJqZWN0PHZvaWQ+KClcbiAgcHJpdmF0ZSBzb3VyY2U6IE9ic2VydmFibGU8VD5cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHZpZXc6IFZpZXdDb250YWluZXJSZWYsXG4gICAgcHJpdmF0ZSBjaGFuZ2VzOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBuZXh0VGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPE9ic2VydmVDb250ZXh0PFQ+PlxuICApIHtcbiAgICB0aGlzLm5leHRUZW1wbGF0ZVJlZiA9IG5leHRUZW1wbGF0ZVJlZlxuICB9XG5cbiAgQElucHV0KClcbiAgc2V0IG5neE9ic2VydmUoc291cmNlOiBPYnNlcnZhYmxlPFQ+KSB7XG4gICAgaWYgKHRoaXMuc291cmNlICYmIHNvdXJjZSAhPT0gdGhpcy5zb3VyY2UpIHtcbiAgICAgIHRoaXMudW5zdWJzY3JpYmUubmV4dCh1bmRlZmluZWQpXG4gICAgfVxuICAgIGlmIChzb3VyY2UgJiYgc291cmNlICE9PSB0aGlzLnNvdXJjZSkge1xuICAgICAgaWYgKHRoaXMuYmVmb3JlVGVtcGxhdGVSZWYpIHtcbiAgICAgICAgdGhpcy52aWV3LmNsZWFyKClcbiAgICAgICAgdGhpcy5uZXh0Vmlld1JlZiA9IHVuZGVmaW5lZFxuICAgICAgICB0aGlzLmVycm9yVmlld1JlZiA9IHVuZGVmaW5lZFxuICAgICAgICB0aGlzLmJlZm9yZVZpZXdSZWYgPSB0aGlzLnZpZXcuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMuYmVmb3JlVGVtcGxhdGVSZWYpXG4gICAgICB9XG4gICAgICB0aGlzLmluaXQucGlwZShcbiAgICAgICAgY29uY2F0TWFwKCgpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5iZWZvcmVUZW1wbGF0ZVJlZikge1xuICAgICAgICAgICAgdGhpcy52aWV3LmNsZWFyKClcbiAgICAgICAgICAgIHRoaXMubmV4dFZpZXdSZWYgPSB1bmRlZmluZWRcbiAgICAgICAgICAgIHRoaXMuZXJyb3JWaWV3UmVmID0gdW5kZWZpbmVkXG4gICAgICAgICAgICB0aGlzLmJlZm9yZVZpZXdSZWYgPSB0aGlzLnZpZXcuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMuYmVmb3JlVGVtcGxhdGVSZWYpXG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBzb3VyY2VcbiAgICAgICAgfSksXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLnVuc3Vic2NyaWJlKVxuICAgICAgKS5zdWJzY3JpYmUodmFsdWUgPT4ge1xuICAgICAgICB0aGlzLnZpZXcuY2xlYXIoKVxuICAgICAgICB0aGlzLmVycm9yVmlld1JlZiA9IHVuZGVmaW5lZFxuICAgICAgICB0aGlzLmJlZm9yZVZpZXdSZWYgPSB1bmRlZmluZWRcbiAgICAgICAgdGhpcy5uZXh0Vmlld1JlZiA9IHRoaXMudmlldy5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy5uZXh0VGVtcGxhdGVSZWYsIG5ldyBPYnNlcnZlQ29udGV4dDxUPih2YWx1ZSkpXG4gICAgICAgIHRoaXMuY2hhbmdlcy5tYXJrRm9yQ2hlY2soKVxuICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICBpZiAodGhpcy5lcnJvclRlbXBsYXRlUmVmKSB7XG4gICAgICAgICAgdGhpcy52aWV3LmNsZWFyKClcbiAgICAgICAgICB0aGlzLmJlZm9yZVZpZXdSZWYgPSB1bmRlZmluZWRcbiAgICAgICAgICB0aGlzLm5leHRWaWV3UmVmID0gdW5kZWZpbmVkXG4gICAgICAgICAgdGhpcy5lcnJvclZpZXdSZWYgPSB0aGlzLnZpZXcuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMuZXJyb3JUZW1wbGF0ZVJlZiwgbmV3IEVycm9yQ29udGV4dChlcnJvcikpXG4gICAgICAgICAgdGhpcy5jaGFuZ2VzLm1hcmtGb3JDaGVjaygpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuICAgIHRoaXMuc291cmNlID0gc291cmNlXG4gIH1cblxuICBASW5wdXQoKVxuICBzZXQgbmd4T2JzZXJ2ZUVycm9yKHJlZjogVGVtcGxhdGVSZWY8RXJyb3JDb250ZXh0Pikge1xuICAgIGFzc2VydFRlbXBsYXRlKCduZ3hPYnNlcnZlRXJyb3InLCByZWYpXG4gICAgdGhpcy5lcnJvclRlbXBsYXRlUmVmID0gcmVmXG4gICAgaWYgKHRoaXMuZXJyb3JWaWV3UmVmKSB7XG4gICAgICB0aGlzLnZpZXcuY2xlYXIoKVxuICAgICAgdGhpcy5lcnJvclZpZXdSZWYgPSB0aGlzLnZpZXcuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMuZXJyb3JUZW1wbGF0ZVJlZiwgdGhpcy5lcnJvclZpZXdSZWYuY29udGV4dClcbiAgICB9XG4gIH1cblxuICBASW5wdXQoKVxuICBzZXQgbmd4T2JzZXJ2ZUJlZm9yZShyZWY6IFRlbXBsYXRlUmVmPHVuZGVmaW5lZD4pIHtcbiAgICBhc3NlcnRUZW1wbGF0ZSgnbmd4T2JzZXJ2ZUJlZm9yZScsIHJlZilcbiAgICB0aGlzLmJlZm9yZVRlbXBsYXRlUmVmID0gcmVmXG4gICAgaWYgKHRoaXMuYmVmb3JlVmlld1JlZikge1xuICAgICAgdGhpcy52aWV3LmNsZWFyKClcbiAgICAgIHRoaXMuYmVmb3JlVmlld1JlZiA9IHRoaXMudmlldy5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy5iZWZvcmVUZW1wbGF0ZVJlZilcbiAgICB9XG4gIH1cblxuICBASW5wdXQoKVxuICBzZXQgbmd4T2JzZXJ2ZU5leHQocmVmOiBUZW1wbGF0ZVJlZjxPYnNlcnZlQ29udGV4dDxUPj4pIHtcbiAgICBhc3NlcnRUZW1wbGF0ZSgnbmd4T2JzZXJ2ZU5leHQnLCByZWYpXG4gICAgdGhpcy5uZXh0VGVtcGxhdGVSZWYgPSByZWZcbiAgICBpZiAodGhpcy5uZXh0Vmlld1JlZikge1xuICAgICAgdGhpcy52aWV3LmNsZWFyKClcbiAgICAgIHRoaXMubmV4dFZpZXdSZWYgPSB0aGlzLnZpZXcuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMubmV4dFRlbXBsYXRlUmVmLCB0aGlzLm5leHRWaWV3UmVmLmNvbnRleHQpXG4gICAgICB0aGlzLmNoYW5nZXMubWFya0ZvckNoZWNrKClcbiAgICB9XG4gIH1cblxuICBzdGF0aWMgbmdUZW1wbGF0ZUNvbnRleHRHdWFyZDxUPihkaXI6IE5neE9ic2VydmU8VD4sIGN0eDogYW55KTogY3R4IGlzIE9ic2VydmVDb250ZXh0PE5vbk51bGxhYmxlPFQ+PiB7XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMudW5zdWJzY3JpYmUubmV4dCh1bmRlZmluZWQpXG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmluaXQubmV4dCh1bmRlZmluZWQpXG4gICAgdGhpcy5pbml0LmNvbXBsZXRlKClcbiAgfVxuXG59XG4iXX0=